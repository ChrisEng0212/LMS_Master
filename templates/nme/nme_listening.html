{% extends "layout.html" %}

{% block content %}

<div id="vue-app">

    <div class="content-section">
            <h1> Novel Listening </h1>

    </div>

    <div class="content-section">
      <legend class="border-bottom mb-4"> Listening List </legend>

      <div v-for="(entry, idx) in lObj">


        <audio :src="entry[ 1 ][ 'audio' ]" controls></audio>

        <br>

        <span> [[ entry[ 1 ][ 'passGaps' ] ]] <span>

        <br>
        <br>

        <div v-for="(word, key) in entry[ 1 ][ 'words' ]" :key="key">
            [[key+1]]
            <td :id="word">
                <select  type="text" style="width: 50%" name="words" v-model="entry[1]['wordsNull'][key]">
                    <option v-for="option in entry[ 1 ][ 'words' ]" :value="option">[[option]]</option>
                </select>
                <br>
                <br>
            </td>
        </div>

        <button class="btn btn-success" @click="checkAnswer(idx)">check</button>

        <br>
        <hr>
        <br>

        <audio :src="entry[ 2 ][ 'audio' ]" controls></audio>

        <div v-for="(sentence, key) in entry[ 2 ][ 'passSplit' ]">
            [[key+1]]
        <td :id="sentence">
            <select  type="text" style="width: 100%" name="sentences" v-model="entry[2]['sentences'][key]">
                <option v-for="option in entry[ 2 ][ 'passSplit' ]" :value="option">[[option]]</option>
            </select>
            <br>
            <br>
        </td>
        </div>

        <button class="btn btn-info" @click="checkSplit(idx)">check</button>

        <br>
        <hr>
        <br>

    </div>

</div>

<span id="user" style="display:none">{{current_user.username}}</span>
<span id="lString" style="display:none">{{lString}}</span>

</div> <!-- end of Vue app -->


{% endblock %}

{% block script %}

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

<script type="text/javascript" >


var lString = document.getElementById('lString').innerHTML

var lObj = JSON.parse(lString)
console.log('lObj', lObj);


startVue()

function startVue(){ new Vue({

    el: '#vue-app',
    delimiters: ['[[', ']]'],
    mounted: function(){
    },
    data: {
        lObj: lObj,
        answers: {
            11: true,
            12: true,
            21: true,
            22: true
        }
    },
    methods: {
        goTo: function(task, index) {

          let name = document.getElementById('user').innerHTML

          var str = window.location.href

          let url = (str).split('nme_')[0] + task + '/'+ index
          console.log('goTO', url);
            window.location = url
            console.log('DONE');
        },
        checkScore: function () {
           let score = 0
            for (let s in this.answers) {
                if (this.answers[s] === 1) {
                    score += 1
                }
            }
            return score
        },
        checkAnswer: function (idx) {
            let str1 = this.lObj[idx][1][ 'wordsNull' ].toString()
            let str2 = this.lObj[idx][1][ 'wordList' ].toString()
            console.log(str1 + str2)
            if (str1 == str2 ) {
                if (this.answers[idx+1]) {
                   this.answers[idx+1] = 1
                }
                alert('Correct - your score is ' + this.checkScore())
            } else {
                if (this.answers[idx+1] == true) {
                   this.answers[idx+1] = null
                }
                alert('Wrong '+ '\nYour Answer: ' + str1 + '\nCorrect Answer: ' + str2)
                alert('Your score is ' + this.checkScore())
            }
        },
        checkSplit: function (idx) {
            let str1 = this.lObj[idx][2][ 'sentences' ].toString()
            let str2 = this.lObj[idx][2][ 'passAns' ].toString()
            console.log(str1 + str2)
            if (str1 == str2 ) {
                if (this.answers[idx+2]) {
                   this.answers[idx+2] = 1
                }
                alert('Correct - your score is ' + this.checkScore())
            } else {
                if (this.answers[idx+2] == true) {
                   this.answers[idx+2] = null
                }
                alert('Wrong '+ '\nCorrect Answer: ' + str2)
                alert('Your score is ' + this.checkScore() + '\nYou need at least 6 to pass')

            }
        },
        shuffle: function (array) {
            // Fisher-Yates shuffle
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1)); // random index from 0 to i
                [array[i], array[j]] = [array[j], array[i]]
            }
            return array
        }
    }
})// end NEW VUE



}// endFunction

</script>

{% endblock %}

