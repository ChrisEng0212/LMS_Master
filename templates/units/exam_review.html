{% extends "layout.html" %}

{% block content %}

<div id="vue-app">

<div class="content-section">    
        <h1> Exam Units: {{ title }}  </h1>
    
</div>

<div class="content-section">        
    
    <div style="overflow-x:auto;">
      <table class="table table-sm">
        <thead>
            <tr>              
              <th scope="col" >Question</th>                                         
            </tr>
        </thead> 
        
        <tbody>
        <template v-for="(qSet, key) in examOBJ" > 
            
            <tr>
              <td style="background:lightgrey">
                <h6>[[ key ]]</h6>      
              </td>
            </tr>
            <template v-for="(qa, k) in qSet">
                <tr> 
                    <td>
                      <h6>[[ k ]]</h6>
                  
                      <select style="height:30px;width:150px;color:white;background:burlywood" :id="[[ qa[0] ]]" name="questions">  
                        <option :value="0"> -- </option>
                          <template v-for="x in shuffle(qa)">
                              <option :value="[[ x ]]">[[ x ]]</option>                             
                          </template>
                      </select>

                 
                      <br>

                    </td>
                </tr> 
              </template>
        </template>

        </tbody>
      </table>

      <button class="btn btn-warning" @click="submitExam()"> Submit </button>
    </div>

</div>   

 

</div> <!-- end of Vue app -->



<span id="dictString" style="display:none">{{Dict}}</span>

{% endblock %}

{% block script %}   

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

<script type="text/javascript" >


var OBJ = document.getElementById('dictString').innerHTML
var examOBJ = JSON.parse(OBJ)
console.log('Exam', examOBJ);

var str = window.location.href
var browser_info = str.split('exams/')[1] 
var test = browser_info.split('/')[0] 
var unit = browser_info.split('/')[1] 
console.log(unit, test);


startVue()

function startVue(){ 
  
  let vue = new Vue({   

    el: '#vue-app',
    delimiters: ['[[', ']]'],
    mounted: function(){
      //resort snlOBJ
       
    },
    data: {
        examOBJ: examOBJ, 
        errorCount : 0,
        questionCount : 0,  
        exam : 'mock', 
        grade : 0,
        tries : 0     
    }, 
    methods: {              
        goTo: function() {                    
          var str = window.location.href
          let url = str.split('exams')[0] + 'exam_list'
          console.log('goTO', url);
          window.location = url
        },
        submitExam: function() {
          //check if dropdown answers match          
          for (var topic in vue.examOBJ){
            for (var question in vue.examOBJ[topic]){
                vue.questionCount +=1
                var correct_answer = vue.examOBJ[topic][question][0]

                console.log(question, correct_answer);
                var e = document.getElementById(correct_answer) 
                  if (e.options[e.selectedIndex].value != correct_answer ) {
                      vue.errorCount += 1
                      e.setAttribute("style", "height:30px;width:150px;color:white;background:lightcoral")
                      console.log(vue.errorCount);
                  }
                  else {
                    e.setAttribute("style", "height:30px;width:150px;color:white;background:lightseagreen")
                  }
              }
          }

          if (vue.errorCount > 0){
              vue.tries +=1
              alert('Sorry, you have ' + vue.errorCount + ' incorrect answers. Please try again')
              var floatGrade = (vue.questionCount - vue.errorCount)*20/vue.questionCount 
              var percentGrade = Math.round(floatGrade)
              vue.errorCount = 0 
              vue.questionCount = 0 
              vue.updateGrades(percentGrade)                      
          }          
          else{
              alert('Great, all answers are correct')
              vue.tries +=1
              vue.updateGrades(20)              
          }
        }, 
        updateGrades: function(percentGrade) {
          
          $.ajax({
              data : {
                test : test,                         
                unit : unit, 
                grade : percentGrade,  
                tries : vue.tries          
              },
              type : 'POST',
              url : '/updateExam',               
            })
            .done(function(data) { 
              vue.tries = data.tries
              if (vue.tries > 3){          
                alert('too many tries - grade updated') 
                vue.goTo()   
              }
              else if (percentGrade == 20 ){                
                vue.goTo()   
              }            
            })
            .fail(function(){
                alert('error has occurred');
            }); 
        },
        shuffle: function(arg) {
          //Durstenfeld shuffle:  https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array
          arrayString = JSON.stringify(arg)
          array = JSON.parse(arrayString)
          
          for (var i = array.length - 1; i > 0; i--) {
              var j = Math.floor(Math.random() * (i + 1));
              var temp = array[i];
              array[i] = array[j];
              array[j] = temp;
            }   
          console.log(array);
          return array       
        },
    }          
})// end NEW VUE



}// endFunction 

</script>  

{% endblock %} 

